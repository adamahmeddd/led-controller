<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Command Center</title>
    <!-- Import Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- Header & Status --- */
        h2 { margin-bottom: 5px; font-weight: 300; letter-spacing: 1px; }
        #status { font-size: 14px; color: #888; margin-bottom: 30px; }
        
        /* --- Connect Button --- */
        #connectBtn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.2s;
            z-index: 10;
        }
        #connectBtn:active { transform: scale(0.95); }

        /* --- The Big Mic Button Wrapper --- */
        .mic-wrapper {
            position: relative;
            margin: 40px 0;
            display: none; /* Hidden until connected */
        }

        /* --- The Mic Button --- */
        .mic-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff512f, #dd2476);
            border: none;
            color: white;
            font-size: 40px;
            cursor: pointer;
            position: relative;
            z-index: 2;
            box-shadow: 0 10px 30px rgba(221, 36, 118, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .mic-btn:active { transform: scale(0.9); }

        /* --- Pulse Animation Rings (The "Sound" UI) --- */
        .pulse-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #ff512f;
            opacity: 0;
        }

        /* Animation when listening */
        .listening .pulse-ring {
            animation: pulse 2s infinite;
        }
        .listening .pulse-ring:nth-child(2) { animation-delay: 0.5s; }
        .listening .pulse-ring:nth-child(3) { animation-delay: 1.0s; }

        @keyframes pulse {
            0% { width: 100px; height: 100px; opacity: 1; border-width: 3px; }
            100% { width: 300px; height: 300px; opacity: 0; border-width: 0px; }
        }

        /* --- Text Feedback --- */
        #transcript {
            font-size: 24px;
            font-weight: bold;
            min-height: 40px;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            text-align: center;
            padding: 0 20px;
        }
        
        #instructions { font-size: 14px; color: #666; margin-top: 10px; }

        /* --- Manual Controls (Subtle) --- */
        .manual-controls {
            margin-top: 40px;
            display: none; /* Hidden until connected */
            gap: 15px;
        }
        .small-btn {
            background: #333;
            border: 1px solid #555;
            color: #ccc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .small-btn:active { background: #555; }

    </style>
</head>
<body>

    <h2>COMMAND CENTER</h2>
    <div id="status">Status: Disconnected</div>

    <button id="connectBtn"><i class="fas fa-bluetooth"></i> Connect System</button>

    <!-- The Voice UI -->
    <div class="mic-wrapper" id="micContainer">
        <div class="pulse-ring"></div>
        <div class="pulse-ring"></div>
        <div class="pulse-ring"></div>
        <button class="mic-btn" id="voiceBtn"><i class="fas fa-microphone"></i></button>
    </div>

    <div id="transcript"></div>
    <div id="instructions" style="display:none">Tap the mic and say "Light On"</div>

    <!-- Backup Buttons -->
    <div class="manual-controls" id="manualControls">
        <button class="small-btn" id="onBtn">Manual ON</button>
        <button class="small-btn" id="offBtn">Manual OFF</button>
    </div>

    <script>
        // --- BLUETOOTH SETUP ---
        const serviceUUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const charUUID    = "0000ffe1-0000-1000-8000-00805f9b34fb";
        let device, characteristic;

        // --- UI ELEMENTS ---
        const connectBtn = document.getElementById('connectBtn');
        const micContainer = document.getElementById('micContainer');
        const voiceBtn = document.getElementById('voiceBtn');
        const transcriptDiv = document.getElementById('transcript');
        const statusDiv = document.getElementById('status');
        const manualControls = document.getElementById('manualControls');
        const instructions = document.getElementById('instructions');

        // --- SPEECH API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            // When mic opens
            recognition.onstart = function() {
                micContainer.classList.add("listening");
                transcriptDiv.innerText = "Listening...";
                transcriptDiv.style.color = "#ff512f";
            };

            // When mic closes
            recognition.onend = function() {
                micContainer.classList.remove("listening");
            };

            // When speech is captured
            recognition.onresult = function(event) {
                const command = event.results[0][0].transcript.toLowerCase();
                transcriptDiv.innerText = '"' + command + '"';
                transcriptDiv.style.color = "#fff";
                processCommand(command);
            };
        } else {
            transcriptDiv.innerText = "Voice not supported in this browser.";
        }

        // --- CONNECT BUTTON LOGIC ---
        connectBtn.addEventListener('click', async () => {
            try {
                statusDiv.innerText = "Scanning for HM-10...";
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUUID] }]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(serviceUUID);
                characteristic = await service.getCharacteristic(charUUID);

                // Update UI on success
                statusDiv.innerText = "Connected: " + device.name;
                statusDiv.style.color = "#4CAF50";
                connectBtn.style.display = 'none'; // Hide connect button
                
                // Show Control UI
                micContainer.style.display = 'block';
                manualControls.style.display = 'flex';
                instructions.style.display = 'block';

                device.addEventListener('gattserverdisconnected', () => {
                    alert("Device Disconnected");
                    location.reload();
                });

            } catch (error) {
                statusDiv.innerText = "Connection Failed";
                console.error(error);
            }
        });

        // --- SEND DATA ---
        async function sendData(data) {
            if (!characteristic) return;
            await characteristic.writeValue(new TextEncoder().encode(data));
        }

        // --- VOICE PROCESSING ---
        function processCommand(cmd) {
            if (cmd.includes("on") || cmd.includes("start") || cmd.includes("open")) {
                sendData("1");
            } 
            else if (cmd.includes("off") || cmd.includes("stop") || cmd.includes("close")) {
                sendData("0");
            }
        }

        // --- EVENTS ---
        voiceBtn.addEventListener('click', () => {
            if(recognition) recognition.start();
        });

        document.getElementById('onBtn').addEventListener('click', () => sendData("1"));
        document.getElementById('offBtn').addEventListener('click', () => sendData("0"));

    </script>
</body>
</html>
